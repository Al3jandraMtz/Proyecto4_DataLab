#NOTA: Product id tiene 96 duplicados, de los cuales estan 214 veces duplicados en total. Buscar siguiente consulta de duplicados_product_desglose

#PRIMERA CONSULTA GENERAL
-- Contar valores duplicados en la columna 'product_id'
SELECT 
    'product_id' AS column_name, 
    COUNT(*) AS duplicate_count 
FROM (
    SELECT 
        product_id 
    FROM 
        p4-datalab.Data_Set.amazon_product 
    GROUP BY 
        product_id 
    HAVING 
        COUNT(*) > 1
) AS duplicates

UNION ALL

-- Contar valores duplicados en la columna 'product_name'
SELECT 
    'product_name' AS column_name, 
    COUNT(*) AS duplicate_count 
FROM (
    SELECT 
        product_name 
    FROM 
        p4-datalab.Data_Set.amazon_product
    GROUP BY 
        product_name 
    HAVING 
        COUNT(*) > 1
) AS duplicates

UNION ALL

-- Contar valores duplicados en la columna 'category'
SELECT 
    'category' AS column_name, 
    COUNT(*) AS duplicate_count 
FROM (
    SELECT 
        category 
    FROM 
        p4-datalab.Data_Set.amazon_product
    GROUP BY 
        category 
    HAVING 
        COUNT(*) > 1
) AS duplicates

UNION ALL

-- Contar valores duplicados en la columna 'discounted_price'
SELECT 
    'discounted_price' AS column_name, 
    COUNT(*) AS duplicate_count 
FROM (
    SELECT 
        discounted_price 
    FROM 
        p4-datalab.Data_Set.amazon_product
    GROUP BY 
        discounted_price 
    HAVING 
        COUNT(*) > 1
) AS duplicates

UNION ALL

-- Contar valores duplicados en la columna 'actual_price'
SELECT 
    'actual_price' AS column_name, 
    COUNT(*) AS duplicate_count 
FROM (
    SELECT 
        actual_price 
    FROM 
        p4-datalab.Data_Set.amazon_product
    GROUP BY 
        actual_price 
    HAVING 
        COUNT(*) > 1
) AS duplicates

UNION ALL

-- Contar valores duplicados en la columna 'discount_percentage'
SELECT 
    'discount_percentage' AS column_name, 
    COUNT(*) AS duplicate_count 
FROM (
    SELECT 
        discount_percentage 
    FROM 
        p4-datalab.Data_Set.amazon_product
    GROUP BY 
        discount_percentage 
    HAVING 
        COUNT(*) > 1
) AS duplicates

UNION ALL

-- Contar valores duplicados en la columna 'about_product'
SELECT 
    'about_product' AS column_name, 
    COUNT(*) AS duplicate_count 
FROM (
    SELECT 
        about_product 
    FROM 
        p4-datalab.Data_Set.amazon_product
    GROUP BY 
        about_product 
    HAVING 
        COUNT(*) > 1
) AS duplicates

ORDER BY 
    column_nameÂ ASC;

#SEGUNDA CONSULTA
--Duplicados de product_id descontados de los originales

-- Contar solo los duplicados (excluyendo el dato original) por columna en `proyecto4datalab.amazon.amazon_product`

WITH ProductIDDuplicates AS (
    SELECT
        "product_id",
        COUNT(*) - 1 AS duplicate_count
    FROM
        `p4-datalab.Data_Set.amazon_product`
    GROUP BY
        product_id
    HAVING
        COUNT(*) > 1
),
ProductNameDuplicates AS (
    SELECT
        "product_name",
        COUNT(*) - 1 AS duplicate_count
    FROM
        `p4-datalab.Data_Set.amazon_product`
    GROUP BY
        product_name
    HAVING
        COUNT(*) > 1
),
CategoryDuplicates AS (
    SELECT
        "category",
        COUNT(*) - 1 AS duplicate_count
    FROM
        `p4-datalab.Data_Set.amazon_product`
    GROUP BY
      category
    HAVING
        COUNT(*) > 1
),
DiscountedPriceDuplicates AS (
    SELECT
        "discounted_price",
        COUNT(*) - 1 AS duplicate_count
    FROM
        `p4-datalab.Data_Set.amazon_product`
    GROUP BY
        discounted_price
    HAVING
        COUNT(*) > 1
),
ActualPriceDuplicates AS (
    SELECT
        "actual_price",
        COUNT(*) - 1 AS duplicate_count
    FROM
        `p4-datalab.Data_Set.amazon_product`
    GROUP BY
        actual_price
    HAVING
        COUNT(*) > 1
),
DiscountPercentageDuplicates AS (
    SELECT
        "discount_percentage",
        COUNT(*) - 1 AS duplicate_count
    FROM
        `p4-datalab.Data_Set.amazon_product`
    GROUP BY
        discount_percentage
    HAVING
        COUNT(*) > 1
),
AboutProductDuplicates AS (
    SELECT
        "about_product",
        COUNT(*) - 1 AS duplicate_count
    FROM
        `p4-datalab.Data_Set.amazon_product`
    GROUP BY
        about_product
    HAVING
        COUNT(*) > 1
)

SELECT
    COALESCE((SELECT SUM(duplicate_count) FROM ProductIDDuplicates), 0) AS product_id_duplicates,
    COALESCE((SELECT SUM(duplicate_count) FROM ProductNameDuplicates), 0) AS product_name_duplicates,
    COALESCE((SELECT SUM(duplicate_count) FROM CategoryDuplicates), 0) AS category_duplicates,
    COALESCE((SELECT SUM(duplicate_count) FROM DiscountedPriceDuplicates), 0) AS discounted_price_duplicates,
    COALESCE((SELECT SUM(duplicate_count) FROM ActualPriceDuplicates), 0) AS actual_price_duplicates,
    COALESCE((SELECT SUM(duplicate_count) FROM DiscountPercentageDuplicates), 0) AS discount_percentage_duplicates,
    COALESCE((SELECT SUM(duplicate_count) FROM AboutProductDuplicates), 0) AS about_product_duplicates;

#TERCERA CONSULTA
--Duplicados desglosados 
-- Subconsulta para calcular el total de duplicados por variable
WITH DuplicatesCount AS (
  SELECT
    product_id,
    COUNT(*) AS duplicado
  FROM
    `p4-datalab.Data_Set.amazon_product`
  GROUP BY
    product_id
  HAVING
    COUNT(*) > 1
)

-- Consulta principal que muestra los duplicados (excluyendo el original) y el total de duplicados
SELECT
  product_id,
  (duplicado - 1) AS duplicados_excluyendo_original,
  SUM(duplicado - 1) OVER () AS total_duplicados_excluyendo_original
FROM
  DuplicatesCount;

